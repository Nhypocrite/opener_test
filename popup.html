<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>页面 B (弹窗)</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: #eef; font-size: 14px; line-height: 1.6; }
        .log-box { border: 1px solid #99c; padding: 10px; min-height: 60px; background-color: #fdfdff; margin-top: 10px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 200px; overflow-y: auto; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; margin-top: 15px; }
        strong { color: red; }
    </style>
    <!-- 引入 VConsole -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
      // 初始化 VConsole
      var vConsole = new VConsole();
      console.log("[页面 B] VConsole 初始化完毕。");
    </script>
</head>
<body>
    <h1>页面 B (弹窗)</h1>
    <p>这是模拟的回调页面。请打开 VConsole 查看详细日志。</p>
    <button id="sendAndCloseButton">发送消息回页面 A 并尝试关闭</button>

    <h2>页面 B 状态与日志:</h2>
    <div id="pageBLog" class="log-box">页面 B 初始化...</div>

    <script>
        const sendAndCloseButton = document.getElementById('sendAndCloseButton');
        const pageBLog = document.getElementById('pageBLog');

        // 在页面和控制台都记录日志的辅助函数
        function logOnPageB(message) {
            console.log(`[页面 B] ${message}`);
            // 只保留最新的几条日志在页面上
            const logLines = pageBLog.innerHTML.split('<br>').slice(-5);
            pageBLog.innerHTML = logLines.join('<br>') + `<br>${new Date().toLocaleTimeString()}: ${message}`;
            pageBLog.scrollTop = pageBLog.scrollHeight; // 滚动到底部
        }

        logOnPageB("页面脚本开始执行。");

        // 检查 window.opener 状态
        if (window.opener && !window.opener.closed) {
            logOnPageB("检测到有效的 window.opener (父窗口)。");
        } else if (window.opener && window.opener.closed) {
            logOnPageB("<strong>警告: 检测到 window.opener，但它似乎已经关闭了！</strong>");
        } else {
            logOnPageB("<strong>警告: window.opener 不存在或无法访问！将无法向父窗口发送消息。</strong>");
        }

        sendAndCloseButton.onclick = () => {
            logOnPageB("按钮被点击，开始执行发送消息和关闭操作...");

            // 1. 准备要发送的数据
            const dataToSend = {
                status: 'success-manual',
                message: '来自页面 B 的手动消息',
                timestamp: new Date().toISOString(),
                payload: { detail: '这是手动触发的数据' }
            };
            logOnPageB(`准备发送的数据: ${JSON.stringify(dataToSend)}`);

            // 2. 尝试发送消息
            logOnPageB("尝试调用 window.opener.postMessage...");
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage(dataToSend, '*'); // '*' 允许任何来源，生产环境应指定来源
                    logOnPageB("window.opener.postMessage 调用成功。");
                } catch (error) {
                    logOnPageB(`<strong>错误: 调用 postMessage 时发生异常: ${error.message}</strong>`);
                    console.error('[页面 B] postMessage 异常:', error);
                }
            } else {
                logOnPageB("<strong>警告: window.opener 无效或已关闭，无法发送消息。</strong>");
            }

            // 3. 尝试关闭窗口
            logOnPageB("尝试调用 window.close()...");
            try {
                window.close();
                // 注意: 如果 close() 成功，后续的脚本可能不会执行或日志不会显示
                logOnPageB("window.close() 调用已执行 (不保证窗口实际已关闭)。");

                // 尝试检查自身是否关闭 (可能不准确，因为检查时可能还没完全关闭)
                setTimeout(() => {
                    if (window.closed) {
                         logOnPageB("延迟检查：窗口似乎已关闭。"); // 可能看不到这条，如果真关了
                    } else {
                         logOnPageB("延迟检查：窗口似乎仍未关闭。");
                         pageBLog.innerHTML += '<br><strong style="color:red;">提示：窗口未能自动关闭！可能需要手动关闭。</strong>';
                    }
                }, 100); // 稍微延迟检查

            } catch (error) {
                logOnPageB(`<strong>错误: 调用 window.close() 时发生异常: ${error.message}</strong>`);
                console.error('[页面 B] window.close() 异常:', error);
            }

            logOnPageB("发送和关闭操作尝试完毕。");
        };

        // 监听 beforeunload 事件，看看关闭时是否触发
        window.addEventListener('beforeunload', (event) => {
            logOnPageB("检测到 'beforeunload' 事件。窗口即将卸载或关闭。");
            // 这里不能可靠地阻止由脚本发起的关闭
        });

        logOnPageB("页面加载完成，按钮事件监听器已设置。");
    </script>
</body>
</html>